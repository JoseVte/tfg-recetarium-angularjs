'use strict';

var recetarium = angular.module('recetariumApp', [
    'environment',
    'ngRoute',
    'ngMaterial',
    'ngMessages',
    'ngSanitize',
    'ngAnimate',
    'ui.router',
    'Animations',
    'NotificationProviders',
    'HomeController',
    'AuthServices',
    'AuthController',
    'RecipeServices',
    'RecipeController'
]);

// Routes
recetarium.config(['$routeProvider', '$locationProvider', function($routeProvider, $locationProvider) {
    $routeProvider
        .when('/', { templateUrl: 'views/home.html', controller: ''})
        .when('/login', { templateUrl: 'views/auth/login.html', controller: 'Login' })
        .when('/logout', { template: '', controller: 'Logout' })
        .when('/register', { templateUrl: 'views/auth/register.html', controller: 'Register' })
        .when('/recipes', { templateUrl: 'views/recipe/index.html', controller: 'RecipeAll' })
        .otherwise({ redirectTo: '/' });
}]);

// CORS configuration
recetarium.config(['$httpProvider', function($httpProvider) {
    $httpProvider.defaults.useXDomain = true;
    delete $httpProvider.defaults.headers.common['X-Requested-With'];
}]);

// Themes
recetarium.config(['$mdThemingProvider', function($mdThemingProvider) {
    //
}]);

// Environment configuration
recetarium.config(['envServiceProvider', function (envServiceProvider) {
    envServiceProvider.config({
        domains: {
            development: ['localhost', '127.0.0.1'],
            production: ['recetarium-angular.herokuapp.com']
        },
        vars: {
            development: {
                apiUrl: 'http://localhost:9000'
            },
            production: {
                apiUrl: 'https://recetarium.herokuapp.com'
            }
        }
    });
    envServiceProvider.check();
}]);

//
recetarium.run(function ($rootScope, $location, $http, AuthService) {
    $rootScope.location = $location;

    if (localStorage.globals) {
        $rootScope.globals = JSON.parse(localStorage.globals);
    } else {
        $rootScope.globals = {};
    }

    $rootScope.$on('$locationChangeStart', function (ev, next, current) {
        $rootScope.IsAuthed = AuthService.IsAuthed();
        $rootScope.IsHome = ($location.path() == '/');

        var token = $rootScope.globals.token;

        if (token && $location.path() === '/login' && $location.path() === '/register') {
            //Redirect to home if logged in
            $location.path('/');
        } else if (($location.path() !== '/login' && $location.path() !== '/register' && $location.path() !== '/' && $location.path() !== '/recipes') && !token) {
            //Redirect if not logged in
            $location.path('/login');
        }

        switch ($location.path()) {
            case '/login':
            case '/register':
                $rootScope.tabColor = '#00BFA5';
                $rootScope.headerTheme = 'header-theme-auth';
                $rootScope.bodyTheme = 'body-theme-auth';
                break;
            default:
                $rootScope.tabColor = '#DD2C00';
                $rootScope.headerTheme ='header-theme-default';
                $rootScope.bodyTheme = 'body-theme-default';
        }
    });
});

// Function extras
String.prototype.trunc = function( n, useWordBoundary ){
    var isTooLong = this.length > n,
    s_ = isTooLong ? this.substr(0,n-1) : this;
    s_ = (useWordBoundary && isTooLong) ? s_.substr(0,s_.lastIndexOf(' ')) : s_;
    return  isTooLong ? s_ + '&hellip;' : s_;
};

var authController = angular.module('AuthController', []);

authController.controller('Login',
    ['$scope', '$rootScope', '$location', 'AuthService',
    function ($scope, $rootScope, $location, AuthService) {
        $rootScope.headerTitle = 'Login';

        $scope.login = function () {
            $scope.dataLoading = true;
            AuthService.Login($scope.email, $scope.password, function (response) {
                AuthService.SaveCredentials(response.data.auth_token,
                    JSON.parse(AuthService.ParseJwt(response.data.auth_token).sub));
                $location.path('/');
            }, function (response) {
                $('#customErrorLogin').addClass('hide');
                $('#customErrorLoginEmail').addClass('hide');
                $('#customErrorLoginPassword').addClass('hide');

                if (response.status == 401) {
                    $scope.customErrorLogin = "El email o la contrase√±a son incorrectos";
                    $('#customErrorLogin').removeClass('hide');
                } else if (response.status == 400) {
                    var email = response.data.email;
                    if (email) {
                        $scope.customErrorLoginEmail = email;
                        $('#customErrorLoginEmail').removeClass('hide');
                    }

                    var password = response.data.password;
                    if (password) {
                        $scope.customErrorLoginPassword = password;
                        $('#customErrorLoginPassword').removeClass('hide');
                    }
                }
                $scope.dataLoading = false;
            });
        };
    }]
);

authController.controller('Register',
    ['$scope', '$rootScope','$location', 'AuthService',
    function ($scope, $rootScope, $location, AuthService) {
        $rootScope.headerTitle = 'Registro';

        $scope.register = function () {
            $scope.dataLoading = true;
            var user = {
                username: $scope.username,
                email: $scope.email,
                password: $scope.password,
                passwordRepeat: $scope.passwordRepeat,
                first_name: $scope.first_name,
                last_name: $scope.last_name
            };
            AuthService.Register(user, function (response) {
                AuthService.SaveCredentials(response.data.auth_token,
                    JSON.parse(AuthService.ParseJwt(response.data.auth_token).sub));
                $location.path('/');
            }, function (response) {
                $('#customErrorRegister').addClass('hide');
                $('#customErrorRegisterUsername').addClass('hide');
                $('#customErrorRegisterEmail').addClass('hide');
                $('#customErrorRegisterPassword').addClass('hide');
                $('#customErrorRegisterPasswordRepeat').addClass('hide');

                if (response.status == 400) {
                    var username = response.data.username;
                    if (username) {
                        $scope.customErrorRegisterUsername = '';
                        for (var i = 0; i < username.length; i++) {
                            $scope.customErrorRegisterUsername += username[i] + '\n'
                        }
                        $('#customErrorRegisterUsername').removeClass('hide');
                    }

                    var email = response.data.email;
                    if (email) {
                        $scope.customErrorRegisterEmail = '';
                        for (var i = 0; i < email.length; i++) {
                            $scope.customErrorRegisterEmail += email[i] + '\n'
                        }
                        $('#customErrorRegisterEmail').removeClass('hide');
                    }

                    var password = response.data.password;
                    if (password) {
                        $scope.customErrorRegisterPassword = '';
                        for (var i = 0; i < password.length; i++) {
                            $scope.customErrorRegisterPassword += password[i] + '\n'
                        }
                        $('#customErrorRegisterPassword').removeClass('hide');
                    }

                    var passwordRepeat = response.data.passwordRepeat;
                    if (passwordRepeat) {
                        $scope.customErrorRegisterPasswordRepeat = '';
                        for (var i = 0; i < passwordRepeat.length; i++) {
                            $scope.customErrorRegisterPasswordRepeat += passwordRepeat[i] + '\n'
                        }
                        $('#customErrorRegisterPasswordRepeat').removeClass('hide');
                    }
                } else {
                    $scope.customErrorRegister = response.data.error;
                    $('#customErrorRegister').removeClass('hide');
                }
                $scope.dataLoading = false;
            });
        }
    }]
);

authController.controller('Logout',
    ['$scope', '$location', 'AuthService',
    function ($scope,$location, AuthService) {
        AuthService.ClearCredentials();
        $location.path('/');
    }]
);

var homeController = angular.module('HomeController', []);

homeController.controller('Header',
    ['$scope', '$mdSidenav', '$timeout', '$location',
    function ($scope, $mdSidenav, $timeout, $location) {
        $scope.toggleLeft = buildDelayedToggler('left');

        $scope.navLinks = [
            { title: 'Home', url: '/'},
            { title: 'Recetas', url: '/recipes'}
        ];

        $scope.navTo = function (ev, url) {
            closeSideNav('left');
            if ($location.path() !== url) $location.path(url);
        }

        $scope.getClassActive = function(path) {
            var cur_path = $location.path().substr(0, path.length);
            if (cur_path == path) {
                if($location.path().substr(0).length > 1 && path.length == 1 )
                    return "";
                else
                    return "active";
            } else {
                return "";
            }
        }

        function debounce(func, wait, context) {
            var timer;
            return function debounce() {
                var context = $scope, args = Array.prototype.slice.call(arguments);
                $timeout.cancel(timer);
                timer = $timeout(function() {
                    timer = undefined;
                    func.apply(context, args);
                }, wait || 10);
            };
        };

        function buildDelayedToggler(navID) {
            return debounce(function() {
                $mdSidenav(navID).toggle().then(function () {});
            }, 200);
        };

        function closeSideNav(navID) {
            $mdSidenav(navID).close().then(function () {});
        }
    }
]);

var recipeController = angular.module('RecipeController', []);

recipeController .controller('RecipeAll',
    ['$scope', '$rootScope', '$location', '$sce', 'RecipeService', 'NotificationProvider',
    function ($scope, $rootScope, $location, $sce, RecipeService, NotificationProvider) {
        $rootScope.headerTitle = 'Recetas';
        $scope.pagination = {
            page: 1,
            size: 10
        };

        $scope.sizes = [10, 30, 50];

        $scope.$watch(function() {
            return $location.search();
        }, function (newVal, oldVal) {
            if (!newVal.page) newVal.page = 1;
            if (!newVal.size) newVal.size = 10;
            $scope.pagination = newVal;
            $scope.getRecipes();
        });

        $scope.selectSize = function () {
            $location.search("size", $scope.pagination.size);
        }

        $scope.getRecipes = function () {
            $rootScope.progressBarActivated = true;
            RecipeService.all($scope.pagination, function (response) {
                var responseData = response.data;
                $scope.recipes = responseData.data;
                $scope.total = responseData.total;
                $scope.current = responseData["link-self"];
                if (responseData["link-prev"]) $scope.prev = responseData["link-prev"];
                if (responseData["link-next"]) $scope.next = responseData["link-next"];
                $rootScope.progressBarActivated = false;
            }, function (response) {
                NotificationProvider.notify({
                    title: 'Un error ha ocurrido',
                    text: 'Ha ocurrido un error mientras se cargaban las recetas. Por favor, intentelo mas tarde.',
                    type: 'error',
                    addclass: 'custom-error',
                    icon: 'material-icons md-light',
                    styling: 'fontawesome',
                });
                $('.ui-pnotify-icon .material-icons').html('warning');
                $rootScope.progressBarActivated = false;
            });
        }

        $scope.description = function(recipeDescription) {
            if (recipeDescription) return $sce.trustAsHtml(recipeDescription.trunc(80, true));
        }
    }]
);

var animationModule = angular.module('Animations', []);

animationModule.animation('.animation-card-recipes', function () {
    return {
        enter: function (element, done) {
            element.css({
                opacity: 0
            });
            jQuery(element).animate({
                opacity: 1
            }, done);

            return function(isCancelled) {
                if(isCancelled) {
                    jQuery(element).stop();
                }
            }
        },
        leave : function(element, done) {
            element.css('opacity', 1);
            jQuery(element).animate({
                opacity: 0
            }, done);
            return function(isCancelled) {
                if(isCancelled) {
                    jQuery(element).stop();
                }
            }
        },
        move : function(element, done) {
            element.css('opacity', 0);
            jQuery(element).animate({
                opacity: 1
            }, done);
            return function(isCancelled) {
                if(isCancelled) {
                    jQuery(element).stop();
                }
            }
        },

        addClass : function(element, className, done) {},
        removeClass : function(element, className, done) {}
    }
});

var notificationProvider = angular.module('NotificationProviders', []);

notificationProvider.provider('NotificationProvider',
    [function () {
        var settings = { styling: 'bootstrap3' };
        this.setDefaults = function(defaults) { settings = defaults };
        PNotify.desktop.permission();

        this.$get = [ function() {
            return {
                /* ========== SETTINGS RELATED METHODS =============*/
                getSettings: function() {
                    return settings;
                },
                /* ============== NOTIFICATION METHODS ==============*/
                notice: function(content) {
                    var hash = angular.copy(settings);
                    hash.type = 'notice';
                    hash.text = content;
                    return this.notify(hash);
                },
                info: function(content) {
                    var hash = angular.copy(settings);
                    hash.type = 'info';
                    hash.text = content;
                    return this.notify(hash);
                },
                success: function(content) {
                    var hash = angular.copy(settings);
                    hash.type = 'success';
                    hash.text = content;
                    return this.notify(hash);
                },
                error: function(content) {
                    var hash = angular.copy(settings);
                    hash.type = 'error';
                    hash.text = content;
                    return this.notify(hash);
                },
                notify: function(hash) {
                    return new PNotify(hash);
                }
            };
        }];
    }]
);

var authServices = angular.module('AuthServices', ['ngResource']);

authServices.factory('AuthService',
    ['$http', '$rootScope', '$timeout',
    function ($http, $rootScope, $timeout) {
        var service = {};

        service.Login = function (email, password, callbackOk, callbackError) {
            $http.post(
                'https://recetarium.herokuapp.com/auth/login',
                { email: email, password: password },
                { headers: {'Accept': 'application/json', 'Content-Type': 'application/json'} }
            ).then(function (response) {
                callbackOk(response);
            }, function (response) {
                callbackError(response);
            });
        };

        service.Register = function (user, callbackOk, callbackError) {
            $http.post(
                'https://recetarium.herokuapp.com/auth/register',
                user, { headers: {'Accept': 'application/json', 'Content-Type': 'application/json'} }
            ).then(function (response) {
                callbackOk(response);
            }, function (response) {
                callbackError(response);
            });
        };

        service.SaveCredentials = function (token, user) {
            $rootScope.globals = {
                token: token,
                user: user,
            };

            localStorage.globals = JSON.stringify($rootScope.globals);
        };

        service.ClearCredentials = function () {
            $rootScope.globals = {};
            localStorage.removeItem('globals');
        };

        service.ParseJwt = function(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace('-', '+').replace('_', '/');
            return JSON.parse(atob(base64));
        };

        service.GetJwt = function() {
            if ($rootScope.globals) return $rootScope.globals.token;
            else return null;
        };

        service.IsAuthed = function() {
            var token = service.GetJwt();
            if (token) {
                var params = service.ParseJwt(token);
                return Math.round(new Date().getTime() / 1000) <= params.exp;
            } else {
                return false;
            }
        };

        return service;
    }]
);

var recipeService = angular.module('RecipeServices', ['ngResource']);

recipeService.factory('RecipeService',
    ['$http', '$rootScope', 'envService',
    function ($http, $rootScope, envService) {
        var service = {
            apiUrl: envService.read('apiUrl')
        };

        service.all = function (pagination, callbackOk, callbackError) {
            $http.get(
                service.apiUrl + '/recipes',
                {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    params: pagination
                }
            ).then(function (response) {
                callbackOk(response);
            }, function (response) {
                callbackError(response);
            });
        }

        return service;
    }]
);
